---
description: ç½‘æ˜“äº‘ä¿¡ç™½æ¿SDKäº‹ä»¶ç›‘å¬å®Œæ•´æŒ‡å—
globs: ["**/*whiteboard*", "**/*board*", "src/views/**/*.vue"]
alwaysApply: true
---

# ç½‘æ˜“äº‘ä¿¡ç™½æ¿SDKäº‹ä»¶ç›‘å¬å®Œæ•´æŒ‡å—

åŸºäº[å®˜æ–¹DrawPluginæ¥å£æ–‡æ¡£](https://doc.yunxin.163.com/whiteboard/api-refer/web/typedoc/Latest/zh/html/interfaces/DrawPlugin.DrawPlugin-1.html)çš„äº‹ä»¶å¤„ç†æœ€ä½³å®è·µã€‚

## DrawPlugin äº‹ä»¶ç›‘å¬è§„èŒƒ

### åº”ç”¨çŠ¶æ€å˜åŒ–äº‹ä»¶
```typescript
// âœ… å®Œæ•´çš„çŠ¶æ€å˜åŒ–ç›‘å¬
drawPlugin.on('event:appState:change', (stateName: string, value?: any) => {
  switch (stateName) {
    case 'board':
      // Boardåˆ‡æ¢äº‹ä»¶ï¼Œvalueä¸ºIBoardInfos
      console.log('Boardåˆ‡æ¢åˆ°:', value.currBoard)
      console.log('Boardæ˜¾ç¤ºå:', value.currBoardDisplayName)
      handleBoardChange(value)
      break
      
    case 'page':
      // é¡µé¢åˆ‡æ¢äº‹ä»¶ï¼Œvalueä¸ºIPageInfos
      console.log('é¡µé¢åˆ‡æ¢åˆ°:', value.activeIndex)
      console.log('é¡µé¢æ•°æ®:', value.pagePayloads)
      handlePageChange(value)
      break
      
    case 'zoomFactor':
      // ç¼©æ”¾å˜åŒ–äº‹ä»¶ï¼Œvalueä¸ºnumber
      console.log('ç¼©æ”¾å€æ•°å˜ä¸º:', value)
      handleZoomChange(value)
      break
      
    case 'currTool':
      // å·¥å…·åˆ‡æ¢äº‹ä»¶ï¼Œvalueä¸ºstring
      console.log('å·¥å…·åˆ‡æ¢åˆ°:', value)
      handleToolChange(value)
      break
      
    case 'vision':
      // è§†è§’å˜åŒ–äº‹ä»¶ï¼Œvalueä¸ºè§†è§’çŠ¶æ€å¯¹è±¡
      console.log('è§†è§’æ¨¡å¼:', value.mode)
      console.log('ä¸»æ’­:', value.broadcasterName)
      handleVisionChange(value)
      break
      
    case 'selectChange':
      // é€‰æ‹©å˜åŒ–äº‹ä»¶ï¼ŒåŒ…å«ä¸‰ä¸ªå‚æ•°
      console.log('é€‰æ‹©å˜åŒ–:', {
        oldSelected: arguments[1],      // ä¹‹å‰é€‰ä¸­çš„å…ƒç´ IDæ•°ç»„
        newSelected: arguments[2],      // å½“å‰é€‰ä¸­çš„å…ƒç´ IDæ•°ç»„
        nonMedia: arguments[3]          // ééŸ³è§†é¢‘å…ƒç´ IDæ•°ç»„
      })
      handleSelectionChange(arguments[1], arguments[2], arguments[3])
      break
      
    case 'styleUpdate':
      // æ ·å¼æ›´æ–°äº‹ä»¶ï¼Œvalueä¸ºIStyle
      console.log('æ ·å¼æ›´æ–°:', value)
      handleStyleUpdate(value)
      break
      
    case 'clearAvailable':
      // æ¸…ç©ºå¯ç”¨æ€§å˜åŒ–äº‹ä»¶ï¼Œvalueä¸ºboolean
      console.log('æ¸…ç©ºå¯ç”¨æ€§:', value)
      handleClearAvailabilityChange(value)
      break
      
    case 'undoCount':
      // æ’¤é”€æ¬¡æ•°å˜åŒ–äº‹ä»¶ï¼Œvalueä¸ºnumber
      console.log('å¯æ’¤é”€æ¬¡æ•°:', value)
      handleUndoCountChange(value)
      break
      
    case 'redoCount':
      // é‡åšæ¬¡æ•°å˜åŒ–äº‹ä»¶ï¼Œvalueä¸ºnumber
      console.log('å¯é‡åšæ¬¡æ•°:', value)
      handleRedoCountChange(value)
      break
      
    case 'cameraReady':
      // ç›¸æœºå°±ç»ªäº‹ä»¶
      console.log('ç›¸æœºå·²å°±ç»ª')
      handleCameraReady()
      break
      
    default:
      console.log('æœªå¤„ç†çš„çŠ¶æ€å˜åŒ–:', stateName, value)
  }
})

// äº‹ä»¶å¤„ç†å‡½æ•°
function handleBoardChange(boardInfos: IBoardInfos) {
  // å¤„ç†Boardåˆ‡æ¢é€»è¾‘
  updateBoardNavigation(boardInfos)
  updateToolbarForBoard(boardInfos)
}

function handlePageChange(pageInfos: IPageInfos) {
  // å¤„ç†é¡µé¢åˆ‡æ¢é€»è¾‘
  updatePageNavigation(pageInfos)
}

function handleZoomChange(zoomFactor: number) {
  // å¤„ç†ç¼©æ”¾å˜åŒ–é€»è¾‘
  updateZoomUI(zoomFactor)
}

function handleToolChange(toolName: string) {
  // å¤„ç†å·¥å…·åˆ‡æ¢é€»è¾‘
  updateToolUI(toolName)
}

function handleVisionChange(visionState: any) {
  // å¤„ç†è§†è§’å˜åŒ–é€»è¾‘
  updateVisionUI(visionState)
}

function handleSelectionChange(oldIds: string[], newIds: string[], nonMediaIds: string[]) {
  // å¤„ç†é€‰æ‹©å˜åŒ–é€»è¾‘
  updateSelectionUI(oldIds, newIds, nonMediaIds)
}

function handleStyleUpdate(style: IStyle) {
  // å¤„ç†æ ·å¼æ›´æ–°é€»è¾‘
  updateStyleUI(style)
}

function handleClearAvailabilityChange(available: boolean) {
  // å¤„ç†æ¸…ç©ºå¯ç”¨æ€§å˜åŒ–é€»è¾‘
  updateClearButton(available)
}

function handleUndoCountChange(count: number) {
  // å¤„ç†æ’¤é”€æ¬¡æ•°å˜åŒ–é€»è¾‘
  updateUndoButton(count > 0)
}

function handleRedoCountChange(count: number) {
  // å¤„ç†é‡åšæ¬¡æ•°å˜åŒ–é€»è¾‘
  updateRedoButton(count > 0)
}

function handleCameraReady() {
  // ç›¸æœºå°±ç»ªåçš„åˆå§‹åŒ–æ“ä½œ
  console.log('ç›¸æœºå°±ç»ªï¼Œå¯ä»¥è®¾ç½®èƒŒæ™¯å›¾ç‰‡ç­‰æ“ä½œ')
  const cameraBound = drawPlugin.getCameraBound()
  drawPlugin.setPageBackground({
    url: 'background-image-url',
    width: cameraBound.width,
    height: cameraBound.height
  })
}
```

### èµ„æºåŠ è½½äº‹ä»¶
```typescript
// âœ… èµ„æºåŠ è½½ç›‘å¬
drawPlugin.on('event:resource:onload', (resource: IResourceMetaData) => {
  console.log(`èµ„æºåŠ è½½ç»“æœ:`, {
    type: resource.type,        // 'image' | 'video' | 'audio'
    url: resource.url,          // èµ„æºURL
    loaded: resource.loaded,    // æ˜¯å¦åŠ è½½æˆåŠŸ
    error: resource.error       // é”™è¯¯ä¿¡æ¯(å¦‚æœæœ‰)
  })
  
  if (resource.loaded) {
    console.log(`âœ… ${resource.type} åŠ è½½æˆåŠŸ: ${resource.url}`)
    handleResourceLoadSuccess(resource)
  } else {
    console.error(`âŒ ${resource.type} åŠ è½½å¤±è´¥: ${resource.url}`, resource.error)
    handleResourceLoadError(resource)
  }
})

function handleResourceLoadSuccess(resource: IResourceMetaData) {
  // èµ„æºåŠ è½½æˆåŠŸå¤„ç†
  switch (resource.type) {
    case 'image':
      // å›¾ç‰‡åŠ è½½æˆåŠŸ
      break
    case 'video':
      // è§†é¢‘åŠ è½½æˆåŠŸ
      break
    case 'audio':
      // éŸ³é¢‘åŠ è½½æˆåŠŸ
      break
  }
}

function handleResourceLoadError(resource: IResourceMetaData) {
  // èµ„æºåŠ è½½å¤±è´¥å¤„ç†
  WhiteBoardSDK.showToast({
    type: 'error',
    msg: `${resource.type}èµ„æºåŠ è½½å¤±è´¥`,
    time: 3000
  })
}
```

### ç™½æ¿å¯¼å…¥äº‹ä»¶
```typescript
// âœ… ç™½æ¿å¯¼å…¥è¿›åº¦ç›‘å¬
drawPlugin.on('event:importBoard', (action: 'start' | 'finish') => {
  if (action === 'start') {
    console.log('ğŸ”„ å¼€å§‹å¯¼å…¥ç™½æ¿å†…å®¹...')
    // æ˜¾ç¤ºå¯¼å…¥è¿›åº¦UI
    showImportProgress(true)
    
    // ç¦ç”¨ç”¨æˆ·æ“ä½œ
    drawPlugin.enableDraw(false)
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    WhiteBoardSDK.showToast({
      type: 'info',
      msg: 'æ­£åœ¨å¯¼å…¥ç™½æ¿å†…å®¹ï¼Œè¯·ç¨å€™...',
      time: 10000
    })
    
  } else if (action === 'finish') {
    console.log('âœ… ç™½æ¿å†…å®¹å¯¼å…¥å®Œæˆ!')
    // éšè—å¯¼å…¥è¿›åº¦UI
    showImportProgress(false)
    
    // é‡æ–°å¯ç”¨ç”¨æˆ·æ“ä½œ
    drawPlugin.enableDraw(true)
    
    // éšè—åŠ è½½æç¤º
    WhiteBoardSDK.hideToast()
    
    // æ˜¾ç¤ºå®Œæˆæç¤º
    WhiteBoardSDK.showToast({
      type: 'success',
      msg: 'ç™½æ¿å†…å®¹å¯¼å…¥å®Œæˆ!',
      time: 3000
    })
  }
})

function showImportProgress(show: boolean) {
  // æ˜¾ç¤º/éšè—å¯¼å…¥è¿›åº¦UI
  const progressElement = document.getElementById('import-progress')
  if (progressElement) {
    progressElement.style.display = show ? 'block' : 'none'
  }
}
```

## ToolCollection äº‹ä»¶ç›‘å¬

### æ–‡æ¡£æ·»åŠ äº‹ä»¶
```typescript
// âœ… å·¥å…·æ æ–‡æ¡£äº‹ä»¶ç›‘å¬
toolCollection.on('docAdd', (docList: any[], allDocs: any[]) => {
  console.log('ğŸ“„ æ–‡æ¡£æ·»åŠ äº‹ä»¶:', {
    newDocs: docList,        // æ–°æ·»åŠ çš„æ–‡æ¡£åˆ—è¡¨
    allDocs: allDocs         // æ‰€æœ‰æ–‡æ¡£åˆ—è¡¨
  })
  
  // å¤„ç†æ–‡æ¡£æ·»åŠ é€»è¾‘
  handleDocumentAdd(docList, allDocs)
})

function handleDocumentAdd(docList: any[], allDocs: any[]) {
  // æ›´æ–°æ–‡æ¡£åˆ—è¡¨UI
  updateDocumentList(allDocs)
  
  // å¦‚æœæ·»åŠ äº†åŠ¨æ€æ–‡æ¡£ï¼Œæ›´æ–°å·¥å…·æ 
  const hasTransDoc = docList.some(doc => doc.type === 'transDoc')
  if (hasTransDoc) {
    updateToolbarForTransDoc()
  }
}
```

## äº‹ä»¶ç›‘å¬æœ€ä½³å®è·µ

### ç»Ÿä¸€äº‹ä»¶ç®¡ç†å™¨
```typescript
// âœ… äº‹ä»¶ç®¡ç†å™¨ç±»
class WhiteboardEventManager {
  private drawPlugin: DrawPlugin
  private toolCollection: ToolCollectionInstance
  private eventListeners: Map<string, Function[]> = new Map()
  
  constructor(drawPlugin: DrawPlugin, toolCollection: ToolCollectionInstance) {
    this.drawPlugin = drawPlugin
    this.toolCollection = toolCollection
    this.setupAllListeners()
  }
  
  private setupAllListeners() {
    this.setupAppStateListeners()
    this.setupResourceListeners()
    this.setupImportListeners()
    this.setupToolCollectionListeners()
  }
  
  private setupAppStateListeners() {
    this.drawPlugin.on('event:appState:change', (stateName: string, ...args: any[]) => {
      // åˆ†å‘åˆ°å…·ä½“çš„å¤„ç†å™¨
      this.emit(`appState:${stateName}`, ...args)
    })
  }
  
  private setupResourceListeners() {
    this.drawPlugin.on('event:resource:onload', (resource: IResourceMetaData) => {
      this.emit('resource:loaded', resource)
    })
  }
  
  private setupImportListeners() {
    this.drawPlugin.on('event:importBoard', (action: string) => {
      this.emit('board:import', action)
    })
  }
  
  private setupToolCollectionListeners() {
    this.toolCollection.on('docAdd', (docList: any[], allDocs: any[]) => {
      this.emit('doc:added', docList, allDocs)
    })
  }
  
  // æ³¨å†Œäº‹ä»¶ç›‘å¬
  on(eventName: string, callback: Function) {
    if (!this.eventListeners.has(eventName)) {
      this.eventListeners.set(eventName, [])
    }
    this.eventListeners.get(eventName)!.push(callback)
  }
  
  // ç§»é™¤äº‹ä»¶ç›‘å¬
  off(eventName: string, callback?: Function) {
    if (callback) {
      const listeners = this.eventListeners.get(eventName) || []
      const index = listeners.indexOf(callback)
      if (index > -1) {
        listeners.splice(index, 1)
      }
    } else {
      this.eventListeners.delete(eventName)
    }
  }
  
  // è§¦å‘äº‹ä»¶
  private emit(eventName: string, ...args: any[]) {
    const listeners = this.eventListeners.get(eventName) || []
    listeners.forEach(callback => {
      try {
        callback(...args)
      } catch (error) {
        console.error(`äº‹ä»¶å¤„ç†é”™è¯¯ [${eventName}]:`, error)
      }
    })
  }
  
  // é”€æ¯ç®¡ç†å™¨
  destroy() {
    this.eventListeners.clear()
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const eventManager = new WhiteboardEventManager(drawPlugin, toolCollection)

// ç›‘å¬Boardå˜åŒ–
eventManager.on('appState:board', (boardInfos: IBoardInfos) => {
  console.log('Board changed:', boardInfos)
})

// ç›‘å¬é¡µé¢å˜åŒ–
eventManager.on('appState:page', (pageInfos: IPageInfos) => {
  console.log('Page changed:', pageInfos)
})

// ç›‘å¬èµ„æºåŠ è½½
eventManager.on('resource:loaded', (resource: IResourceMetaData) => {
  console.log('Resource loaded:', resource)
})

// ç»„ä»¶é”€æ¯æ—¶æ¸…ç†
onUnmounted(() => {
  eventManager.destroy()
})
```

### äº‹ä»¶é˜²æŠ–å¤„ç†
```typescript
// âœ… é«˜é¢‘äº‹ä»¶é˜²æŠ–
import { debounce } from 'lodash-es'

// ç¼©æ”¾äº‹ä»¶é˜²æŠ–
const debouncedZoomHandler = debounce((zoomFactor: number) => {
  console.log('ç¼©æ”¾ç¨³å®šåœ¨:', zoomFactor)
  updateZoomUI(zoomFactor)
}, 300)

drawPlugin.on('event:appState:change', (stateName: string, value: any) => {
  if (stateName === 'zoomFactor') {
    debouncedZoomHandler(value)
  }
})

// é€‰æ‹©å˜åŒ–äº‹ä»¶é˜²æŠ–
const debouncedSelectionHandler = debounce((oldIds: string[], newIds: string[], nonMediaIds: string[]) => {
  console.log('é€‰æ‹©ç¨³å®š:', { oldIds, newIds, nonMediaIds })
  updateSelectionUI(oldIds, newIds, nonMediaIds)
}, 100)

drawPlugin.on('event:appState:change', (stateName: string) => {
  if (stateName === 'selectChange') {
    debouncedSelectionHandler(arguments[1], arguments[2], arguments[3])
  }
})
```

### é”™è¯¯å¤„ç†
```typescript
// âœ… äº‹ä»¶ç›‘å¬é”™è¯¯å¤„ç†
function safeEventListener(eventName: string, handler: Function) {
  return (...args: any[]) => {
    try {
      handler(...args)
    } catch (error) {
      console.error(`äº‹ä»¶ç›‘å¬é”™è¯¯ [${eventName}]:`, error)
      
      // ä¸ŠæŠ¥é”™è¯¯
      reportError({
        type: 'event_listener_error',
        eventName,
        error: error.message,
        args
      })
    }
  }
}

// ä½¿ç”¨å®‰å…¨çš„äº‹ä»¶ç›‘å¬
drawPlugin.on('event:appState:change', safeEventListener('appState:change', (stateName, value) => {
  // äº‹ä»¶å¤„ç†é€»è¾‘
  handleAppStateChange(stateName, value)
}))
```

éµå¾ªè¿™äº›äº‹ä»¶ç›‘å¬è§„èŒƒå¯ä»¥ç¡®ä¿ç™½æ¿åº”ç”¨çš„çŠ¶æ€åŒæ­¥å’Œç”¨æˆ·äº¤äº’ä½“éªŒã€‚